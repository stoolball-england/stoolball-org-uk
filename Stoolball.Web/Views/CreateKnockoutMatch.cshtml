@inherits Umbraco.Web.Mvc.UmbracoViewPage<CreateKnockoutMatchViewModel>
@using ClientDependency.Core.Mvc
@using Stoolball.Web.Matches
@section head {
    <meta name="robots" content="noindex,follow" />
}
@{
    Html.EnableClientValidation();
    Html.EnableUnobtrusiveJavaScript();
    Html.RequiresJs("~/scripts/jquery.validate.min.js");
    Html.RequiresJs("~/scripts/jquery.validate.unobtrusive.min.js");

    Html.RequiresJs("~/js/libs/jquery.autocomplete.min.js", 50);
    Html.RequiresCss("~/css/autocomplete.min.css");

    Html.RequiresCss("~/css/related-items.min.css");
    Html.RequiresJs("~/js/related-item.js");

    Html.RequiresJs("/umbraco/lib/tinymce/tinymce.min.js", 90);
    Html.RequiresJs("/js/tinymce.js");

    var h1 = string.Empty;
    if (Model.Team != null)
    {
        h1 = $"Add a knockout match for {Model.Team.TeamName}";
    }
    else if (Model.Season != null)
    {
        h1 = $"Add a knockout match in the {Model.Season.SeasonFullName()}";
    }
}

<h1>@h1</h1>

@if (Model.IsAuthorized)
{
    using (Html.BeginUmbracoForm<CreateKnockoutMatchSurfaceController>
        ("CreateMatch"))
    {
        @Html.AntiForgeryToken()
        @Html.ValidationSummary(true)

        <button class="sr-only">Save match</button>

        if (Model.Match.Season != null)
        {
            @Html.HiddenFor(m => Model.Match.Season.SeasonId)
        }
        else
        {
            <div class="form-group">
                @Html.LabelFor(m => Model.Match.Season.SeasonId)
                @Html.DropDownListFor(m => Model.Match.Season.SeasonId, Model.PossibleSeasons, new { @class = "form-control", required = "required", aria_describedby = "match-season" })
                @Html.ValidationMessageFor(m => Model.Match.Season.SeasonId, null, new { id = "match-season" })
            </div>
        }

        <div class="form-group">
            @Html.LabelFor(m => Model.Match.MatchName)
            <p class="form-text" id="match-name-help"><small>For 'Semi-final', 'Cup final' or similar matches. For most matches, leave this blank.</small></p>
            @Html.TextBoxFor(m => Model.Match.MatchName, new { @class = "form-control", aria_describedby = "match-name match-name-help" })
            @Html.ValidationMessageFor(m => Model.Match.MatchName, null, new { id = "match-name" })
        </div>

        <div class="form-group">
            @Html.LabelFor(m => Model.MatchDate)
            @Html.TextBoxFor(m => Model.MatchDate, "{0:yyyy-MM-dd}", new { @type = "date", @class = "form-control", required = "required", aria_describedby = "match-date" })
            @Html.ValidationMessageFor(m => Model.MatchDate, null, new { id = "match-date" })
        </div>

        <div class="form-group">
            @Html.LabelFor(m => Model.StartTime)
            @Html.TextBoxFor(m => Model.StartTime, "{0:HH:mm}", new { @type = "time", @class = "form-control", aria_describedby = "start-time" })
            @Html.ValidationMessageFor(m => Model.StartTime, null, new { id = "start-time" })
        </div>

        <div class="form-group">
            @Html.LabelFor(m => Model.HomeTeamId)
            @Html.DropDownListFor(m => Model.HomeTeamId, Model.PossibleTeams, "To be confirmed", new { @class = "form-control", aria_describedby = "home-team" })
            @Html.ValidationMessageFor(m => Model.HomeTeamId, null, new { id = "home-team" })
        </div>

        <div class="form-group">
            @Html.LabelFor(m => Model.AwayTeamId)
            @Html.DropDownListFor(m => Model.AwayTeamId, Model.PossibleTeams, "To be confirmed", new { @class = "form-control", aria_describedby = "away-team" })
            @Html.ValidationMessageFor(m => Model.AwayTeamId, null, new { id = "away-team" })
        </div>

        <div class="form-group related-item">
            @Html.LabelFor(m => Model.MatchLocationName)
            @if (Model.MatchLocationId.HasValue)
            {
                <div class="related-item__selected">
                    <div class="related-item__selected__section">
                        @Html.TextBoxFor(m => Model.MatchLocationName, new { @class = "form-control", @readonly = "readonly" })
                    </div>
                    <div class="related-item__delete related-item__selected__section">
                        @Html.HiddenFor(m => Model.MatchLocationId, new { @class = "related-item__data related-item__id" })
                        <button class="text-danger">@Html.Partial("_DeleteIcon", (Model.MatchLocationId.Value.ToString(), $"Remove {Model.MatchLocationName} from this match"))</button>
                    </div>
                </div>
                Model.MatchLocationName = string.Empty;
                @Html.TextBoxFor(m => Model.MatchLocationName, new
                {
                    @class = "form-control related-item__search",
                    placeholder = "Type the ground or sports hall name",
                    autocomplete = "off",
                    type = "search",
                    data_url = "/api/locations/autocomplete",
                    data_template = "location-template",
                    aria_label = "Type a ground or sports hall name add and press down arrow to select from the matching choices",
                    disabled = "disabled"
                })
            }
            else
            {
                @Html.TextBoxFor(m => Model.MatchLocationName, new
                {
                    @class = "form-control related-item__search",
                    placeholder = "Type the ground or sports hall name",
                    autocomplete = "off",
                    type = "search",
                    data_url = "/api/locations/autocomplete",
                    data_template = "location-template",
                    aria_label = "Type a ground or sports hall name add and press down arrow to select from the matching choices"
                })
            }
        </div>
        <script type="text/x-template" id="location-template">
            <div class="related-item__selected">
                <div class="related-item__selected__section">
                    <input type="text" readonly="readonly" value="{{value}}" class="form-control" id="MatchLocationName" name="MatchLocationName" />
                </div>
                <div class="related-item__delete related-item__selected__section">
                    <input name="MatchLocationId" class="related-item__data related-item__id" type="hidden" value="{{data}}" />
                    <button class="text-danger">@Html.Partial("_DeleteIcon", ("{{data}}", "Remove {{value}} from this match"))</button>
                </div>
            </div>
        </script>

        <div class="form-group">
            @Html.LabelFor(m => Model.Match.MatchNotes)
            @Html.TextAreaFor(m => Model.Match.MatchNotes, new { @class = "form-control", aria_describedby = "notes-validation" })
            @Html.ValidationMessageFor(m => Model.Match.MatchNotes, null, new { id = "notes-validation" })
        </div>

        <button class="btn btn-primary">Save match</button>
    }
}
else
{
    @Html.Partial("_Login")
}